# WhatIsMyAdaptor - Local Development Docker Compose
# Environment Variables: All variables loaded from stack.env
# Usage: docker-compose --env-file stack.env up -d
# Repository: https://github.com/Robjects-Community/WhatIsMyAdaptor.git

services:
  willowcms:
    image: ${WILLOW_IMAGE}
    container_name: willowcms
    environment:
      # Core Application Settings
      - APP_NAME=${APP_NAME}
      - APP_FULL_BASE_URL=${APP_FULL_BASE_URL}
      - DEBUG=${DEBUG}
      - APP_ENCODING=UTF-8
      - APP_DEFAULT_LOCALE=en_GB
      - APP_DEFAULT_TIMEZONE=Europe/London

      # Security (REQUIRED - Change before deploying!)
      - SECURITY_SALT=${SECURITY_SALT}

      # Database Connection
      - DB_HOST=mysql
      - DB_USERNAME=${MYSQL_USER}
      - DB_PASSWORD=${MYSQL_PASSWORD}
      - DB_DATABASE=${MYSQL_DATABASE}
      - DB_PORT=3306
      - TEST_DB_HOST=mysql
      - TEST_DB_USERNAME=${MYSQL_TEST_USER}
      - TEST_DB_PASSWORD=${MYSQL_PASSWORD}
      - TEST_DB_DATABASE=${MYSQL_TEST_DATABASE}
      - TEST_DB_PORT=3306

      # Email Configuration (Mailpit for local testing)
      - EMAIL_HOST=mailpit
      - EMAIL_PORT=1025
      - EMAIL_TIMEOUT=30
      - EMAIL_USERNAME=
      - EMAIL_PASSWORD=
      - EMAIL_REPLY=${EMAIL_REPLY}
      - EMAIL_NOREPLY=${EMAIL_NOREPLY}

      # Redis Cache & Queue Configuration
      - REDIS_USERNAME=root
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_DATABASE=0
      - REDIS_URL=redis://root:${REDIS_PASSWORD}@redis:6379/0
      - REDIS_TEST_URL=redis://root:${REDIS_PASSWORD}@redis:6379/0
      - QUEUE_DEFAULT_URL=redis://root:${REDIS_PASSWORD}@redis:6379/0
      - QUEUE_TEST_URL=redis://root:${REDIS_PASSWORD}@redis:6379/0

      # Optional API Keys for AI features
      - YOUTUBE_API_KEY=${YOUTUBE_API_KEY}
      - TRANSLATE_API_KEY=${TRANSLATE_API_KEY}

      # Admin User Configuration
      - WILLOW_ADMIN_USERNAME=${WILLOW_ADMIN_USERNAME}
      - WILLOW_ADMIN_PASSWORD=${WILLOW_ADMIN_PASSWORD}
      - WILLOW_ADMIN_EMAIL=${WILLOW_ADMIN_EMAIL}

      # Feature Flags
      - EXPERIMENTAL_TESTS=Off

    volumes:
      - willowcms_logs:/var/log/nginx
      - app_tmp:/var/www/html/tmp
      - app_uploads:/var/www/html/webroot/files

    ports:
      - "${APP_HTTP_PORT}:80"

    depends_on:
      - mysql
      - redis
      - mailpit

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

    restart: unless-stopped
    networks:
      - willow_network

  mysql:
    image: mysql:8.4.3
    container_name: mysql
    platform: linux/amd64
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE}

    command: >
      --character-set-server=utf8mb4
      --collation-server=utf8mb4_unicode_ci
      --mysql-native-password=ON

    volumes:
      - mysql_data:/var/lib/mysql
      - mysql_init:/docker-entrypoint-initdb.d

    ports:
      - "${MYSQL_PORT}:3306"

    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${MYSQL_ROOT_PASSWORD}"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

    restart: unless-stopped
    networks:
      - willow_network

  phpmyadmin:
    image: phpmyadmin:latest
    container_name: phpmyadmin
    environment:
      - PMA_HOST=mysql
      - PMA_USER=root
      - PMA_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - UPLOAD_LIMIT=300M

    ports:
      - "${PHPMYADMIN_PORT}:80"

    depends_on:
      - mysql

    restart: unless-stopped
    networks:
      - willow_network

  jenkins:
    image: ${JENKINS_IMAGE}
    container_name: jenkins
    environment:
      - JAVA_OPTS=-Djenkins.install.runSetupWizard=false

    ports:
      - "${JENKINS_PORT}:8080"

    volumes:
      - jenkins_home:/var/jenkins_home

    restart: unless-stopped
    networks:
      - willow_network

  mailpit:
    image: axllent/mailpit:latest
    container_name: mailpit
    environment:
      - MP_MAX_MESSAGES=5000
      - MP_DATABASE=/data/mailpit.db
      - MP_SMTP_AUTH_ACCEPT_ANY=1
      - MP_SMTP_AUTH_ALLOW_INSECURE=1

    ports:
      - "${MAILPIT_SMTP_PORT}:1025"  # SMTP
      - "${MAILPIT_UI_PORT}:8025"    # Web UI

    volumes:
      - mailpit_data:/data

    restart: unless-stopped
    networks:
      - willow_network

  redis:
    image: redis:7-alpine
    container_name: redis
    command: redis-server --requirepass ${REDIS_PASSWORD}

    ports:
      - "${REDIS_PORT}:6379"

    volumes:
      - redis_data:/data

    healthcheck:
      test: ["CMD", "redis-cli", "--no-auth-warning", "-a", "${REDIS_PASSWORD}", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3

    restart: unless-stopped
    networks:
      - willow_network

  redis-commander:
    image: rediscommander/redis-commander:latest
    container_name: redis-commander
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - HTTP_USER=${REDIS_COMMANDER_USER}
      - HTTP_PASSWORD=${REDIS_COMMANDER_PASSWORD}

    ports:
      - "${REDIS_COMMANDER_PORT}:8081"

    depends_on:
      - redis

    restart: unless-stopped
    networks:
      - willow_network

networks:
  willow_network:
    driver: bridge
    name: ${NETWORK_NAME}

volumes:
  mysql_data:
    name: ${MYSQL_DATA_VOLUME}
    driver: local
  mysql_init:
    name: ${MYSQL_INIT_VOLUME}
    driver: local
  jenkins_home:
    name: ${JENKINS_HOME_VOLUME}
    driver: local
  mailpit_data:
    name: ${MAILPIT_DATA_VOLUME}
    driver: local
  redis_data:
    name: ${REDIS_DATA_VOLUME}
    driver: local
  willowcms_logs:
    name: ${WILLOWCMS_LOGS_VOLUME}
    driver: local
  app_tmp:
    name: ${APP_TMP_VOLUME}
    driver: local
  app_uploads:
    name: ${APP_UPLOADS_VOLUME}
    driver: local
